{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Reporte de Disponibilidad - Agencia de Autos{% endblock %}

{% block page_title %}Reporte de Disponibilidad{% endblock %}

{% block breadcrumbs %}
    <a href="{% url 'home' %}" class="hover:text-gray-700">Inicio</a>
    <span class="mx-2">/</span>
    <span>Reportes</span>
    <span class="mx-2">/</span>
    <span>Disponibilidad</span>
{% endblock %}

{% block current_page %}Disponibilidad{% endblock %}

{% block content_authenticated %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h2 class="text-2xl font-bold text-gray-800">Reporte de Disponibilidad</h2>
        <p class="text-gray-600 mt-1">Análisis de inventario por marca y tipo de vehículo</p>
    </div>
    <div class="flex gap-3">
        <button onclick="window.print()" class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors shadow-sm">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
            </svg>
            Imprimir
        </button>
        <button onclick="exportToExcel()" class="inline-flex items-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors shadow-sm">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Exportar Excel
        </button>
    </div>
</div>

<div class="bg-white rounded-lg shadow-md p-6">
    <!-- Filtros -->
    <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
            <input type="text" id="searchInput" placeholder="Buscar por marca o tipo..." 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Marca</label>
            <select id="marcaFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Todas las marcas</option>
                {% for dato in datos %}
                    <option value="{{ dato.marca }}">{{ dato.marca }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Tipo</label>
            <select id="tipoFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Todos los tipos</option>
                {% for dato in datos %}
                    <option value="{{ dato.tipo_vehiculo }}">{{ dato.tipo_vehiculo }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Métricas Resumen -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
            <div class="text-blue-100 text-sm font-medium mb-2">Total Disponibles</div>
            <div class="text-3xl font-bold">{{ total_disponibles }}</div>
        </div>
        
        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg">
            <div class="text-green-100 text-sm font-medium mb-2">Marcas Diferentes</div>
            <div class="text-3xl font-bold">{{ total_marcas }}</div>
        </div>
        
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
            <div class="text-purple-100 text-sm font-medium mb-2">Precio Promedio</div>
            <div class="text-3xl font-bold">{{ precio_promedio|currency }}</div>
        </div>
    </div>

    <!-- Tabla de Disponibilidad -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Marca
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Tipo de Vehículo
                    </th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Cantidad Disponible
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Precio Promedio
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if datos %}
                    {% for dato in datos %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-semibold text-gray-900">{{ dato.marca }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">{{ dato.tipo_vehiculo }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">
                                {{ dato.cantidad_disponible }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-semibold text-green-600">
                                {{ dato.precio_promedio|currency }}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center">
                            <div class="text-gray-400">
                                <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                </svg>
                                <p class="text-lg font-medium">No hay vehículos disponibles</p>
                                <p class="text-sm mt-1">No se encontraron vehículos disponibles en el inventario</p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Nota Técnica -->
    <div class="mt-6 bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-blue-700">
                    <strong>Técnica SQL:</strong> Este reporte utiliza <code class="bg-blue-100 px-1 rounded">GROUP BY</code> 
                    con funciones de agregación <code class="bg-blue-100 px-1 rounded">COUNT(*)</code> y 
                    <code class="bg-blue-100 px-1 rounded">AVG(precio)</code> para análisis de inventario por marca y tipo.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const marcaFilter = document.getElementById('marcaFilter');
    const tipoFilter = document.getElementById('tipoFilter');
    const tableRows = document.querySelectorAll('tbody tr:not(:last-child)');
    
    // Función de filtrado
    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const marcaSelected = marcaFilter.value;
        const tipoSelected = tipoFilter.value;
        
        tableRows.forEach(row => {
            const marca = row.cells[0]?.textContent.trim();
            const tipo = row.cells[1]?.textContent.trim();
            const searchText = (marca + ' ' + tipo).toLowerCase();
            
            const matchesSearch = searchText.includes(searchTerm);
            const matchesMarca = !marcaSelected || marca === marcaSelected;
            const matchesTipo = !tipoSelected || tipo === tipoSelected;
            
            row.style.display = (matchesSearch && matchesMarca && matchesTipo) ? '' : 'none';
        });
        
        updateMetrics();
    }
    
    // Actualizar métricas según filtros
    function updateMetrics() {
        let totalDisponibles = 0;
        const marcasSet = new Set();
        let totalPrecios = 0;
        let count = 0;
        
        tableRows.forEach(row => {
            if (row.style.display !== 'none') {
                const marca = row.cells[0]?.textContent.trim();
                const cantidad = parseInt(row.cells[2]?.textContent.trim()) || 0;
                const precioText = row.cells[3]?.textContent.trim().replace(/[$,]/g, '');
                const precio = parseFloat(precioText) || 0;
                
                totalDisponibles += cantidad;
                marcasSet.add(marca);
                totalPrecios += precio;
                count++;
            }
        });
        
        const promedioPrecios = count > 0 ? totalPrecios / count : 0;
        
        // Actualizar las métricas en el DOM
        const metricCards = document.querySelectorAll('.text-4xl.font-bold, .text-3xl.font-bold');
        if (metricCards[0]) metricCards[0].textContent = totalDisponibles;
        if (metricCards[1]) metricCards[1].textContent = marcasSet.size;
        if (metricCards[2]) metricCards[2].textContent = '$' + promedioPrecios.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    
    // Event listeners
    searchInput.addEventListener('input', filterTable);
    marcaFilter.addEventListener('change', filterTable);
    tipoFilter.addEventListener('change', filterTable);
    
    // Eliminar duplicados en los filtros
    function removeDuplicates(selectElement) {
        const seen = new Set();
        const options = Array.from(selectElement.options);
        options.forEach(option => {
            if (option.value && seen.has(option.value)) {
                option.remove();
            } else if (option.value) {
                seen.add(option.value);
            }
        });
    }
    
    removeDuplicates(marcaFilter);
    removeDuplicates(tipoFilter);
});

// Función para exportar a Excel (CSV)
function exportToExcel() {
    const table = document.querySelector('table');
    const rows = table.querySelectorAll('tr');
    let csv = [];
    
    // Encabezados
    const headers = [];
    rows[0].querySelectorAll('th').forEach(th => {
        headers.push(th.textContent.trim());
    });
    csv.push(headers.join(','));
    
    // Datos
    for (let i = 1; i < rows.length - 1; i++) {
        const row = rows[i];
        if (row.style.display !== 'none') {
            const cols = [];
            row.querySelectorAll('td').forEach(td => {
                cols.push('"' + td.textContent.trim().replace(/"/g, '""') + '"');
            });
            csv.push(cols.join(','));
        }
    }
    
    // Descargar
    const csvContent = csv.join('\n');
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'reporte_disponibilidad_' + new Date().toISOString().split('T')[0] + '.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>

{% endblock %}
