{% extends 'base.html' %}

{% block title %}Reporte PIVOT - Ventas por Mes y Marca{% endblock %}

{% block content_authenticated %}
<div class="card">
    <h2>Reporte PIVOT - Ventas por Mes y Marca</h2>
    <p style="color: #7f8c8d; margin-bottom: 1.5rem;">
        Este reporte consulta la vista SQL <code>vw_ventas_mes_marca</code> que usa <strong>SUM(CASE...)</strong> para generar un PIVOT.
    </p>
    
    <!-- Selector de año -->
    <form method="get" style="margin: 1.5rem 0;">
        <div style="display: flex; gap: 1rem; align-items: flex-end;">
            <div class="form-group" style="flex: 0 0 200px;">
                <label>Año</label>
                <select name="anio">
                    <option value="2024" {% if anio == 2024 %}selected{% endif %}>2024</option>
                    <option value="2023" {% if anio == 2023 %}selected{% endif %}>2023</option>
                    <option value="2025" {% if anio == 2025 %}selected{% endif %}>2025</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Generar Reporte</button>
            <a href="{% url 'reporte_top5_marcas' %}?anio={{ anio }}" class="btn btn-primary">Ver Top 5 Marcas</a>
        </div>
    </form>
    
    {% if datos %}
    <!-- Tabla PIVOT -->
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Mes</th>
                    {% for dato in datos %}
                        {% if forloop.first %}
                            <!-- Obtener nombres de marcas de las columnas -->
                            {% for key, value in dato.items %}
                                {% if key not in 'anio,mes' and value != None %}
                                    <th>{{ key|title }}</th>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                    <th style="background-color: #e8f4f8;">Total</th>
                </tr>
            </thead>
            <tbody>
                {% for dato in datos %}
                <tr>
                    <td style="font-weight: 600;">
                        {% if dato.mes == 1 %}Enero
                        {% elif dato.mes == 2 %}Febrero
                        {% elif dato.mes == 3 %}Marzo
                        {% elif dato.mes == 4 %}Abril
                        {% elif dato.mes == 5 %}Mayo
                        {% elif dato.mes == 6 %}Junio
                        {% elif dato.mes == 7 %}Julio
                        {% elif dato.mes == 8 %}Agosto
                        {% elif dato.mes == 9 %}Septiembre
                        {% elif dato.mes == 10 %}Octubre
                        {% elif dato.mes == 11 %}Noviembre
                        {% elif dato.mes == 12 %}Diciembre
                        {% endif %}
                    </td>
                    {% for key, value in dato.items %}
                        {% if key not in 'anio,mes,total_mes' and value != None %}
                            <td style="text-align: right;">
                                {% if value %}
                                    ${{ value|floatformat:2 }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        {% endif %}
                    {% endfor %}
                    <td style="text-align: right; font-weight: 600; background-color: #f8f9fa;">
                        ${{ dato.total_mes|floatformat:2 }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 1rem; padding: 1rem; background-color: #e8f4f8; border-radius: 8px;">
        <p style="margin: 0; color: #2c3e50;">
            <strong>Técnica SQL:</strong> Este reporte usa <code>SUM(CASE WHEN marca = 'Toyota' THEN total_venta ELSE 0 END)</code> 
            para crear columnas dinámicas por cada marca (PIVOT).
        </p>
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem; background-color: #f8f9fa; border-radius: 8px;">
        <p style="color: #7f8c8d; font-size: 1.1rem;">
            No hay datos de ventas para el año {{ anio }}
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}
